@model IdentityDemo.ViewModels.ItemsViewModel
@{
    Layout = null;
}

@section Shopidcss {
    <!-- Bootstrap CSS -->
    <link href="~/css/download_css/5_2_3_bootstrap.min.css" rel="stylesheet" />
    <link href="~/css/download_css/5_2_docs.css" rel="stylesheet" />
    <link href="~/css/custom_css/shoplayout.css" rel="stylesheet" />
    <script src="~/js/download_js/5_2_3_bootstrap.bundle.min.js"></script>
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="~/css/download_css/css_family.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
    
    <style>
        .sidebar-open #itemListContainer {
            width: 75%;
        }

        .sidebar-open #sidebarContainer {
            width: 25%;
            display: block !important; /* Ensure sidebar is visible when open */
        }

        .sidebar-closed #itemListContainer {
            width: 100%;
        }

        .sidebar-closed #sidebarContainer {
            display: none; /* Hide sidebar when closed */
        }
    </style>
}
<div class="container-fluid bg-light">
    <div class="row">
        <div class="col-sm-6">
            <h3 class="text-left my-4">Welcome to (Our @Model.Shop.ShopName)</h3>
        </div>
        <div class="col-sm-6 d-flex justify-content-end align-items-center">
            <a href="#" class="btn btn-outline-secondary cart-icon" id="cartButton">
                <i class="fas fa-shopping-cart" style="font-size: 1.5rem;"></i>
                <span class="badge">0</span>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-9" id="itemListContainer">
            <div class="row">
                @foreach (var item in Model.Items)
                {
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <img src="~/img/items/@item.ItemImageName" class="card-img-top" alt="Product Image">
                            <div class="card-body">
                                <h5 class="card-title">@item.ItemName</h5>
                                <p class="card-text"></p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-secondary add-to-cart-btn"
                                                data-id="@item.ItemId"
                                                data-name="@item.ItemName"
                                                data-price="@item.ItemChangedPrice"
                                                data-img="~/img/bg2.jpg">
                                            Add to Cart
                                        </button>
                                    </div>
                                    <div>
                                        <small class="text-muted"><s>$@item.ItemPrice</s></small>
                                        <small class="text-muted">$@item.ItemChangedPrice</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
       
        <div class="col-md-3" id="sidebarContainer">
            <div class="right-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="header1">
                        <h5>Shopping Cart</h5>
                    </div>
                    <div>
                        <i class="fas fa-times close-btn" id="closeSidebar"></i>
                    </div>
                </div>
                <div class="body" id="cartItemsContainer">
                    <!-- Cart items will be listed here dynamically -->
                </div>
                <div class="total-price">
                    Total: $<span id="totalAmount">0.00</span>
                </div>

                <button class="submit-btn" id="submitCart">Pay Now</button>
            </div>
        </div>
        
    </div>
</div>

@section Scripts {
    <script src="~/js/download_js/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Function to update total amount and cart badge
            function updateCart() {
                var totalAmount = 0;
                var itemCount = 0;

                // Calculate total amount from all cart items
                $('.cart-item').each(function () {
                    var itemPrice = parseFloat($(this).data('price'));
                    var quantity = parseInt($(this).find('.item-quantity').val());
                    totalAmount += itemPrice * quantity;
                    itemCount += quantity;
                });

                // Update total amount display
                $('#totalAmount').text(totalAmount.toFixed(2));

                // Update cart badge
                $('#cartButton .badge').text(itemCount);
            }

            // Add to cart functionality
            $(document).on('click', '.add-to-cart-btn', function () {
                var itemId = $(this).data('id');
                var itemName = $(this).data('name');
                var itemPrice = parseFloat($(this).data('price'));

                // Check if item already exists in cart
                var existingCartItem = $(`#cartItemsContainer .cart-item[data-id="${itemId}"]`);

                if (existingCartItem.length > 0) {
                    // Item already exists, increment quantity
                    var quantityInput = existingCartItem.find('.item-quantity');
                    var currentQuantity = parseInt(quantityInput.val());
                    quantityInput.val(currentQuantity + 1);
                } else {
                    // Item does not exist, add new item to cart
                    $('#cartItemsContainer').append(`
                                <div class="cart-item d-flex justify-content-between align-items-center mb-2" data-id="${itemId}" data-price="${itemPrice}">
                                    <div>${itemName}</div>
                                    <div class="d-flex align-items-center">
                                        <input type="number" class="form-control item-quantity mr-2" value="1" min="1">
                                        <i class="fas fa-trash-alt remove-item ml-2" style="cursor: pointer;"></i>
                                    </div>
                                </div>
                            `);
                }

                // Update total amount and cart badge
                updateCart();
            });

            // Remove item from cart
            $(document).on('click', '.remove-item', function () {
                var cartItem = $(this).closest('.cart-item');
                var itemPrice = parseFloat(cartItem.data('price'));

                cartItem.remove();

                // Update total amount and cart badge
                updateCart();
            });

            // Toggle sidebar on cart icon click
            $('#cartButton').click(function () {
                $('.right-sidebar').addClass('sidebar-open');
                $('#itemListContainer').removeClass('col-md-12').addClass('col-md-9');
                $('#sidebarContainer').show();
                updateCart(); // Update cart immediately upon opening sidebar
            });

            // Close sidebar when close button is clicked
            $('#closeSidebar').click(function () {
                $('.right-sidebar').removeClass('sidebar-open');
                $('#itemListContainer').removeClass('col-md-9').addClass('col-md-12');
                $('#sidebarContainer').hide();
            });

            // Submit cart functionality
            $('#submitCart').click(function () {
                // Prepare data for submission
                var cartItems = {};

                // Collect cart items details
                $('.cart-item').each(function () {
                    var itemId = $(this).data('id');
                    var quantity = parseInt($(this).find('.item-quantity').val());
                    // Add item to cartItems dictionary
                    cartItems[itemId] = quantity;
                });

                // Create form and submit dynamically
                var form = $('<form action="@Url.Action("Invoice", "Order")" method="post"></form>');

                // Add each item as a hidden input in the form
                $.each(cartItems, function (itemId, quantity) {
                    form.append('<input type="hidden" name="selectedItems[' + itemId + ']" value="' + quantity + '">');
                });

                // Append form to body and submit
                $('body').append(form);
                form.submit();
            });

            // Initially hide sidebar and update layout
            $('.right-sidebar').removeClass('sidebar-open');
            $('#itemListContainer').removeClass('col-md-9').addClass('col-md-12');
            $('#sidebarContainer').hide();
        });
    </script>
}

    <!-- jQuery -->
    <script src="../../plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../../dist/js/adminlte.min.js"></script>
    <!-- AdminLTE for demo purposes -->
    <script src="../../dist/js/demo.js"></script>
}
